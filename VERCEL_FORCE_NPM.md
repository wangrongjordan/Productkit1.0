# 🔧 Vercel 强制使用 NPM 部署方案

## 🚨 问题分析
从构建日志可以看到：
```
Detected 'pnpm-lock.yaml' which may be generated by pnpm@9.x or pnpm@10.x
Using pnpm@10.x based on project creation date
```

**根因**：Vercel 的自动检测机制忽略了我们的配置，仍然选择 pnpm。

## ✅ 已应用的强制修复

### 1. 强化 vercel.json 配置
```json
{
  "framework": "vite",
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "installCommand": "npm install --force",
  "env": {
    "NODE_ENV": "production",
    "ENABLE_EXPERIMENTAL_COREPACK": "0",
    "NPM_CONFIG_FUND": "false", 
    "NPM_CONFIG_AUDIT": "false"
  }
}
```

### 2. 创建 package-lock.json 占位文件
- 强制 Vercel 检测到 npm 环境
- 优先级高于其他包管理器检测

### 3. 增强 .npmrc 配置
```
legacy-peer-deps=true
engine-strict=false
package-lock=true
prefer-offline=false
strict-ssl=true
```

## 🚀 立即执行步骤

### 步骤 1: 提交更改到 Git
```bash
git add .
git commit -m "force: use npm for Vercel deployment"
git push origin main
```

### 步骤 2: 在 Vercel 控制台强制设置
1. 进入项目 → **Settings** → **Build & Output Settings**
2. 点击 **Edit**
3. **重要**：手动输入以下设置：
   ```
   Framework Preset: Other
   Build Command: npm install --force && npm run build
   Output Directory: dist
   Install Command: npm install --force
   ```
4. 点击 **Save**

### 步骤 3: 添加环境变量
在 **Settings** → **Environment Variables** 添加：
```
ENABLE_EXPERIMENTAL_COREPACK = 0
NPM_CONFIG_FUND = false
NPM_CONFIG_AUDIT = false
NODE_VERSION = 18
```

### 步骤 4: 强制重新部署
1. 进入 **Deployments**
2. 点击最新部署的 **...** 菜单
3. 选择 **Redeploy**
4. **关键**：选择 **Use existing Build Cache = NO**
5. 点击 **Redeploy**

## 🔍 验证成功标志

部署成功后应该看到：
```
✓ Installing dependencies with npm install --force
✓ Running build command: npm run build
✓ Build completed successfully
```

**而不是**：
```
❌ Using pnpm@10.x based on project creation date
❌ ERR_PNPM_OUTDATED_LOCKFILE
```

## 🚨 如果仍然失败

### 终极方案：删除项目重建
1. 在 Vercel 控制台完全删除项目
2. 确保 Git 仓库包含我们的修复文件：
   - `package-lock.json` ✅
   - 更新的 `vercel.json` ✅
   - 强化的 `.npmrc` ✅
3. 重新从 GitHub 导入项目
4. 选择 **Other** 作为框架预设
5. 手动设置构建命令

### 备用方案：使用环境变量强制
如果项目无法删除，在环境变量中添加：
```
FORCE_PACKAGE_MANAGER = npm
DISABLE_COREPACK = 1
NPM_USE_PRODUCTION = false
```

## 📞 技术分析

**为什么 Vercel 仍选择 pnpm？**
1. Git 历史中可能包含 pnpm 相关记录
2. 项目创建时的元数据标记
3. Vercel 的启发式检测算法

**我们的解决方案：**
1. ✅ 提供明确的 package-lock.json 文件
2. ✅ 环境变量禁用 Corepack
3. ✅ 强制安装命令 `npm install --force`
4. ✅ 手动覆盖 Vercel 检测

---

## 🎯 现在行动

1. **立即提交代码更改**
2. **在 Vercel 控制台手动设置构建配置**
3. **强制重新部署（不使用缓存）**

这次应该可以强制 Vercel 使用 npm 了！🚀